{

	"variables": {
		"userpass": "bigdata",
		"guestssh_port": "2222",
		"project_name": "vm-install-archetype-virtualbox",
		"keyfile_pub": "vm_guest_id_rsa.pub"
	},

	"builders": [
	{
		"type": "virtualbox",
		"vm_name": "{{user `project_name`}}",
		"output_directory": "{{user `project_name`}}",
		"vboxmanage": [
			["modifyvm", "{{.Name}}", "--natpf1", "guestssh,tcp,,{{user `guestssh_port`}},,22"],
			["modifyvm", "{{.Name}}", "--memory", "1024"]
			],
		"guest_os_type": "Ubuntu_64",
		"iso_url": "http://old-releases.ubuntu.com/releases/precise/ubuntu-12.04.2-server-amd64.iso",
		"iso_checksum": "af5f788aee1b32c4b2634734309cc9e9",
		"iso_checksum_type": "md5",
		"ssh_username": "{{user `userpass`}}",
		"ssh_password": "{{user `userpass`}}",
		"shutdown_command": "echo {{user `userpass`}} | sudo -S shutdown -P now",
		"disk_size": 8000,
		"headless": true,
		"boot_command": [
			"<esc><esc><enter><wait>",
		"/install/vmlinuz noapic ",
		"preseed/url=http://rawgithub.com/mit-probabilistic-computing-project/vm-install-archetype/master/ubuntu-12.04.2-server-preseed.cfg ",
	       	"debian-installer=en_US auto locale=en_US kbd-chooser/method=us ",
	       	"hostname={{ .Name }} ",
	       	"fb=false debconf/frontend=noninteractive ",
	       	"keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=USA ",
	       	"keyboard-configuration/variant=USA console-setup/ask_detect=false ",
	       	"initrd=/install/initrd.gz -- <enter>"
			]
	}
	],

	"provisioners": [
	{
		"type": "shell",
		"inline": ["echo $(whoami)", "echo $HOME"]
        },
        {
		"type": "shell",
		"script": "provision.sh",
		"execute_command": "echo {{user `userpass`}} | {{ .Vars }} sudo -E -S sh '{{ .Path }}'"
        },
        {
                "type": "file",
                "source": "{{user `keyfile_pub`}}",
                "destination": "/home/{{user `userpass`}}/{{user `keyfile_pub`}}"
        },
	{
		"type": "shell",
		"environment_vars": ["keyfile_pub={{user `keyfile_pub`}}"],
		"script": "set_up_ssh_key.sh",
		"execute_command": "chmod +x {{ .Path }}; {{ .Vars }} {{ .Path }} /home/{{user `userpass`}}/{{user `keyfile_pub`}}"

	}
	]

}
